<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STRAFOR.AI HR Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            font-family: 'Poppins', 'Inter', system-ui, sans-serif;
            background: linear-gradient(120deg, #f8e1e7 0%, #e3f0ff 100%);
            min-height: 100vh;
        }
        .index-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem 0;
        }
        .sidebar {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(26,42,56,0.10);
            padding: 2rem 1rem 1rem 1rem;
            margin-right: 2.5rem;
            min-width: 220px;
            max-width: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: fit-content;
        }
        .sidebar-logo img {
            max-width: 120px;
            margin-bottom: 2rem;
        }
        .sidebar-nav {
            width: 100%;
        }
        .sidebar-nav a {
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
            transition: background 0.2s, color 0.2s;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .sidebar-nav a.active, .sidebar-nav a:hover {
            background: #e91e63;
            color: #fff;
        }
        .sidebar-nav i {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }
        .main-content {
            background: rgba(255,255,255,0.98);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(26,42,56,0.10);
            padding: 2.5rem 2rem;
            max-width: 900px;
            width: 100%;
        }
        .section-title, h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: #e91e63;
            letter-spacing: 0.5px;
            margin-bottom: 2rem;
        }
        .tm-card {
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(233,30,99,0.08);
            border: none;
            background: #fff;
            padding: 2rem 1.5rem 1.5rem 1.5rem;
            margin-bottom: 1.5rem;
        }
        .tm-card .card-header {
            background: transparent;
            border-bottom: none;
            padding: 1.5rem 1.5rem 0.5rem 1.5rem;
            font-size: 1.3rem;
            font-weight: 700;
            color: #e91e63;
            margin: 0;
        }
        .tm-card .card-body {
            padding: 2rem 1.5rem 1.5rem 1.5rem;
        }
        /* Responsive Design */
        @media (max-width: 1200px) {
            .index-wrapper {
                flex-direction: column;
                align-items: stretch;
            }
            .sidebar {
                margin: 0 auto 2rem auto;
            }
            .main-content {
                margin: 0 auto;
            }
        }
        @media (max-width: 900px) {
            .index-wrapper {
                flex-direction: column;
                align-items: stretch;
                padding: 1rem 0;
            }
            .sidebar {
                margin: 0 auto 1rem auto;
                min-width: 100%;
                max-width: 100%;
                border-radius: 16px;
                padding: 1.5rem 0.5rem;
            }
            .main-content {
                padding: 1rem;
                border-radius: 16px;
            }
        }
        @media (max-width: 600px) {
            .main-content {
                padding: 0.5rem;
                border-radius: 10px;
            }
            .section-title, h1 {
                font-size: 1.5rem;
            }
            .sidebar {
                padding: 1rem 0.25rem;
                border-radius: 10px;
            }
        }
        /* Dark mode */
        [data-theme="dark"] body {
            background: linear-gradient(135deg, #23242a 0%, #2d2e36 100%);
        }
        [data-theme="dark"] .main-content {
            background: rgba(30,32,38,0.98);
            color: #fff;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
        }
        [data-theme="dark"] .sidebar {
            background: rgba(30,32,38,0.95);
            color: #fff;
            box-shadow: 0 4px 24px rgba(233,30,99,0.10);
        }
        [data-theme="dark"] .sidebar-nav a {
            color: #eee;
        }
        [data-theme="dark"] .sidebar-nav a.active,
        [data-theme="dark"] .sidebar-nav a:hover {
            background: #e91e63;
            color: #fff;
        }
        [data-theme="dark"] .tm-card {
            background: #23242a;
            color: #fff;
            box-shadow: 0 4px 24px rgba(233,30,99,0.10);
        }
        [data-theme="dark"] .tm-card .card-header,
        [data-theme="dark"] .section-title,
        [data-theme="dark"] h1 {
            color: #ff4081;
        }
    </style>
</head>
<body>
    <div class="index-wrapper">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-logo">
                <img src="assets/ChatGPT-Image-3-may-2025_-00_45_24.svg" alt="STRAFOR.AI Logo">
            </div>
            <ul class="sidebar-nav">
                <li><a href="index.html" class="active"><i class="bi bi-speedometer2"></i>Dashboard</a></li>
                <li><a href="vacancies.html"><i class="bi bi-briefcase"></i>Vacancies</a></li>
                <li><a href="settings.html"><i class="bi bi-gear"></i>Settings</a></li>
                <li><a href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i>Logout</a></li>
            </ul>
        </div>
        <!-- Main Content -->
        <div class="main-content">
            <h1 class="section-title">Dashboard</h1>
            <div class="tm-card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-briefcase me-2"></i>Active Vacancies</h5>
                </div>
                <div class="card-body">
                    <h2 class="card-title" id="activeVacanciesCount">0</h2>
                </div>
            </div>
            <div class="tm-card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-people me-2"></i>Total Candidates</h5>
                </div>
                <div class="card-body">
                    <h2 class="card-title" id="totalCandidatesCount">0</h2>
                </div>
            </div>
            <div class="tm-card">
                <div class="card-header">
                    <h5><i class="bi bi-clock-history me-2"></i>Recent Activity</h5>
                </div>
                <div class="card-body" id="recentActivity">
                    <!-- Activity items will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/theme-manager.js"></script>
    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:3000';

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const userRole = localStorage.getItem('userRole');
            
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // Add token to all fetch requests
            const originalFetch = window.fetch;
            window.fetch = function() {
                let [resource, config] = arguments;
                if(config === undefined) {
                    config = {};
                }
                if(config.headers === undefined) {
                    config.headers = {};
                }
                config.headers['Authorization'] = `Bearer ${token}`;
                return originalFetch(resource, config);
            };

            loadDashboardStats();
            loadRecentActivity();
        });

        // Add logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userRole');
            window.location.href = 'login.html';
        }

        // Load dashboard data
        async function loadDashboardStats() {
            try {
                // Get active vacancies count
                const vacanciesResponse = await fetch('http://localhost:3000/api/vacancies');
                const vacancies = await vacanciesResponse.json();
                const activeVacancies = vacancies.filter(vacancy => vacancy.status === 'Active').length;

                // Get candidates count
                const candidatesResponse = await fetch('http://localhost:3000/api/candidates');
                const candidates = await candidatesResponse.json();
                const totalCandidates = candidates.length;

                // Update the dashboard
                document.getElementById('activeVacanciesCount').textContent = activeVacancies;
                document.getElementById('totalCandidatesCount').textContent = totalCandidates;

                // Update the card titles
                document.querySelector('.col-md-6:nth-child(1) .card-subtitle').textContent = 'Active Vacancies';
                document.querySelector('.col-md-6:nth-child(2) .card-subtitle').textContent = 'Total Candidates';

                // Update the icons
                document.querySelector('.col-md-6:nth-child(1) .stats-icon i').className = 'bi bi-briefcase';
                document.querySelector('.col-md-6:nth-child(2) .stats-icon i').className = 'bi bi-people';
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        // Load recent activity
        async function loadRecentActivity() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/dashboard/activity`);
                if (!response.ok) {
                    throw new Error('Failed to fetch recent activity');
                }
                
                const activities = await response.json();
                const activityContainer = document.getElementById('recentActivity');
                activityContainer.innerHTML = '';

                if (activities.length === 0) {
                    activityContainer.innerHTML = `
                        <div class="text-center text-muted p-4">
                            No recent or upcoming activity to display
                        </div>
                    `;
                    return;
                }

                activities.forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item d-flex align-items-center p-3 border-bottom';
                    activityItem.innerHTML = `
                        <div class="activity-icon me-3">
                            <i class="bi ${activity.icon}"></i>
                        </div>
                        <div class="activity-details flex-grow-1">
                            <div class="activity-text">${activity.description}</div>
                            <div class="activity-time text-muted small">${formatActivityTime(activity.timestamp)}</div>
                        </div>
                    `;
                    activityContainer.appendChild(activityItem);
                });
            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('recentActivity').innerHTML = `
                    <div class="text-center text-danger p-4">
                        Error loading recent activity. Please try again later.
                    </div>
                `;
            }
        }

        // Helper function to format activity time
        function formatActivityTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));

            if (date > now) {
                const daysUntil = Math.ceil((date - now) / (1000 * 60 * 60 * 24));
                return daysUntil === 1 ? 'Tomorrow' : `In ${daysUntil} days`;
            }

            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
            if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
            return date.toLocaleDateString();
        }

        // Refresh data every 5 minutes
        let refreshInterval;
        
        function startDataRefresh() {
            // Clear any existing interval
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // Initial load
            loadDashboardStats();
            loadRecentActivity();
            
            // Set up refresh interval (5 minutes)
            refreshInterval = setInterval(() => {
                try {
                    loadDashboardStats();
                    loadRecentActivity();
                } catch (error) {
                    console.error('Error refreshing data:', error);
                    // Stop refreshing if there's an error
                    clearInterval(refreshInterval);
                }
            }, 300000); // 5 minutes
        }

        // Start the refresh cycle
        startDataRefresh();
    </script>
</body>
</html> 